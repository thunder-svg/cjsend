<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thunder • 전적검색 + 비교</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{--bg:#0b0b0c;--fg:#e7e7ea;--muted:#9aa0a6;--card:#151518;--acc:#6ea8fe;--ok:#2ecc71;--bad:#ff6b6b;--warn:#f0ad4e;--line:#242428}
    @media (prefers-color-scheme: light){
      :root{--bg:#f8f9fb;--fg:#0b0b0c;--muted:#60646c;--card:#ffffff;--line:#e7e9ef}
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,Arial}
    a{color:var(--acc);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
    .logo{font-weight:700;letter-spacing:.3px}
    .chip{font-size:12px;padding:2px 8px;border-radius:999px;background:var(--card);border:1px solid var(--line);color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    .g3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:860px){.g2,.g3{grid-template-columns:1fr}}
    input,select,button{height:40px;border-radius:10px;border:1px solid var(--line);background:transparent;color:var(--fg);padding:0 12px}
    input::placeholder{color:var(--muted)}
    button{background:var(--acc);color:#0b0b0c;border:none;font-weight:600;cursor:pointer}
    button[disabled]{opacity:.5;cursor:not-allowed}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .bar{height:10px;background:var(--line);border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:var(--ok)}
    .muted{color:var(--muted)}
    .err{position:fixed;right:14px;bottom:14px;background:#1a1a1f;border:1px solid var(--line);color:#fff;padding:8px 10px;border-radius:12px;font-size:12px}
    .kpi{display:flex;gap:8px;align-items:baseline}
    .kpi .v{font:600 18px/1 system-ui}
    .kpi .l{color:var(--muted);font-size:12px}
    .pill{padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .loading{opacity:.6;pointer-events:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 12h5l3-9 3 18 3-9h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      <div class="logo">Thunder</div>
      <span class="chip">전적검색</span>
      <span class="chip">비교</span>
    </header>

    <section class="grid g2">
      <div class="card">
        <h3 style="margin:0 0 10px">전적 검색</h3>
        <form id="form-search" class="grid" style="grid-template-columns: 110px 1fr 110px; gap:8px">
          <select id="region">
            <option value="kr">KR</option>
            <option value="na1">NA</option>
            <option value="euw1">EUW</option>
            <option value="eun1">EUNE</option>
            <option value="jp1">JP</option>
          </select>
          <input id="name" placeholder="소환사 이름" autocomplete="off" />
          <button id="btn-search" type="submit">검색</button>
        </form>
        <div id="search-out" style="margin-top:12px"></div>
      </div>

      <div class="card">
        <h3 style="margin:0 0 10px">비교하기</h3>
        <form id="form-compare" class="grid" style="grid-template-columns: 110px 1fr 1fr 110px; gap:8px">
          <select id="region2">
            <option value="kr">KR</option>
            <option value="na1">NA</option>
            <option value="euw1">EUW</option>
            <option value="eun1">EUNE</option>
            <option value="jp1">JP</option>
          </select>
          <input id="nameA" placeholder="소환사 A" autocomplete="off" />
          <input id="nameB" placeholder="소환사 B" autocomplete="off" />
          <button id="btn-compare" type="submit">비교</button>
        </form>
        <div id="compare-out" style="margin-top:12px"></div>
      </div>
    </section>

    <section class="card" style="margin-top:12px">
      <div class="row">
        <span class="pill">자동 다크/라이트</span>
        <span class="pill">엔터 제출</span>
        <span class="pill">데모 폴백</span>
        <span class="pill">CORS 안전</span>
      </div>
    </section>
  </div>

  <div id="err" class="err" hidden>0 error</div>

  <script type="module">
    // ====== 환경설정 ======
    // TODO: 너의 Cloudflare Worker 주소로 교체
    const API_BASE = "https://yee.mfleon32.workers.dev/";
    const DEMO = true; // API 미연결 시 true 유지

    // ====== 유틸 ======
    const $ = (sel, el=document) => el.querySelector(sel);
    const outErr = $("#err");
    let errCount = 0;
    const addErr = (e) => {
      errCount++;
      outErr.textContent = errCount + " error";
      outErr.hidden = false;
      console.error(e);
    };
    const setLoading = (el, on) => el.classList.toggle("loading", !!on);

    const json = async (url) => {
      const r = await fetch(url, { headers: { "Accept": "application/json" } });
      if (!r.ok) throw new Error("HTTP " + r.status + " " + url);
      return r.json();
    };

    // ====== API 어댑터 (워커 라우트 규약) ======
    // 워커에 아래 1개 합친 요약 엔드포인트가 있으면 사용:
    // GET /v1/profile?region=kr&name=Faker&count=10
    async function fetchProfile(region, name, count=10) {
      const u = new URL(API_BASE + "/v1/profile");
      u.searchParams.set("region", region);
      u.searchParams.set("name", name);
      u.searchParams.set("count", String(count));
      return json(u.toString());
    }

    // 폴백: 데모 데이터
    function demoProfile(name) {
      const sample = {
        region: "kr",
        name,
        level: 413,
        iconId: 4568,
        rank: { queue: "RANKED_SOLO_5x5", tier: "CHALLENGER", division: "I", lp: 1020, wins: 720, losses: 610 },
        last10: [
          { k:8,d:2,a:7, win:true, cs:220, dur:31, champ:"Ahri" },
          { k:3,d:5,a:9, win:true, cs:180, dur:28, champ:"Orianna" },
          { k:10,d:1,a:11, win:true, cs:242, dur:33, champ:"Azir" },
          { k:2,d:7,a:4, win:false, cs:160, dur:26, champ:"LeBlanc" },
          { k:9,d:3,a:6, win:true, cs:210, dur:29, champ:"Akali" },
          { k:4,d:6,a:8, win:false, cs:190, dur:30, champ:"Syndra" },
          { k:7,d:2,a:5, win:true, cs:230, dur:32, champ:"Ahri" },
          { k:11,d:4,a:3, win:true, cs:250, dur:34, champ:"Azir" },
          { k:6,d:3,a:9, win:true, cs:205, dur:30, champ:"Viktor" },
          { k:1,d:9,a:2, win:false, cs:150, dur:25, champ:"Yone" },
        ]
      };
      return sample;
    }

    // ====== 계산 ======
    function aggKDA(last10){
      const s = last10.reduce((a,m)=>{a.k+=m.k;a.d+=m.d;a.a+=m.a;a.w+=m.win?1:0;return a},{k:0,d:0,a:0,w:0});
      const kda = s.d? (s.k+s.a)/s.d : (s.k+s.a);
      return {games:last10.length, wins:s.w, winrate: Math.round((s.w/last10.length)*100),
              k:s.k, d:s.d, a:s.a, kda: Number(kda.toFixed(2))};
    }
    const fmt = n => n.toLocaleString();

    // ====== 렌더 ======
    function profileCard(p){
      const k = aggKDA(p.last10||[]);
      return `
        <div class="grid g2" style="align-items:center">
          <div class="row" style="align-items:center;gap:12px">
            <div style="width:54px;height:54px;border-radius:14px;background:#222;display:grid;place-items:center;font-weight:700">${String(p.iconId||"")}</div>
            <div>
              <div style="font-weight:700">${p.name} <span class="muted">LV ${fmt(p.level||0)}</span></div>
              <div class="muted">${p.rank? `${p.rank.tier} ${p.rank.division} • ${p.rank.lp}LP`:"Unranked"}</div>
            </div>
          </div>
          <div class="row" style="justify-content:flex-end;gap:16px">
            <div class="kpi"><div class="v">${k.winrate}%</div><div class="l">승률(10)</div></div>
            <div class="kpi"><div class="v">${k.kda}</div><div class="l">KDA</div></div>
            <div class="kpi"><div class="v">${k.k}/${k.d}/${k.a}</div><div class="l">합산</div></div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="grid g3">
          ${laneStat(p.last10,"mid")}
          ${laneStat(p.last10,"top")}
          ${laneStat(p.last10,"adc")}
        </div>
      `;
    }
    function laneStat(last10,label){
      const g = last10.length||1;
      const wins = last10.filter(m=>m.win).length;
      const w = Math.round((wins/g)*100);
      return `<div>
        <div class="row" style="justify-content:space-between"><b>${label.toUpperCase()}</b><span class="muted">${wins}/${g}</span></div>
        <div class="bar"><i style="width:${w}%;background:${w>=50?'var(--ok)':'var(--bad)'}"></i></div>
      </div>`;
    }

    function compareView(a,b){
      const ka = aggKDA(a.last10||[]);
      const kb = aggKDA(b.last10||[]);
      const diff = (x,y)=> (x-y)>0? "+"+(x-y): String(x-y);
      return `
        <div class="grid g2">
          <div class="card">${profileCard(a)}</div>
          <div class="card">${profileCard(b)}</div>
        </div>
        <div class="card" style="margin-top:12px">
          <h4 style="margin:0 0 8px">핵심 지표 비교</h4>
          <div class="grid g3">
            ${kpiBlock("승률(10)", ka.winrate+"%", kb.winrate+"%", diff(ka.winrate,kb.winrate)+"%")}
            ${kpiBlock("KDA", ka.kda, kb.kda, diff(ka.kda,kb.kda))}
            ${kpiBlock("합산 K/D/A", `${ka.k}/${ka.d}/${ka.a}`, `${kb.k}/${kb.d}/${kb.a}`, diff(ka.k+ka.a, kb.k+kb.a))}
          </div>
        </div>
      `;
    }
    function kpiBlock(label, va, vb, delta){
      const d = Number(delta.replace("+",""));
      const good = d>0;
      return `<div class="card">
        <div class="row" style="justify-content:space-between"><b>${label}</b><span class="muted">Δ ${delta}</span></div>
        <div class="row" style="gap:12px;margin-top:8px">
          <div style="flex:1">
            <div class="muted" style="font-size:12px">A</div>
            <div class="bar"><i style="width:50%"></i></div>
            <div style="margin-top:6px">${va}</div>
          </div>
          <div style="flex:1">
            <div class="muted" style="font-size:12px">B</div>
            <div class="bar"><i style="width:50%;background:${good?'var(--bad)':'var(--ok)'}"></i></div>
            <div style="margin-top:6px">${vb}</div>
          </div>
        </div>
      </div>`;
    }

    // ====== 핸들러 ======
    $("#form-search").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const box = $("#search-out");
      box.innerHTML = "";
      const region = $("#region").value.trim();
      const name = $("#name").value.trim();
      if (!name) return;
      setLoading(e.currentTarget, true);
      try{
        let p;
        try{
          p = await fetchProfile(region, name);
        }catch(err){
          if (DEMO) { p = demoProfile(name); }
          else throw err;
        }
        box.innerHTML = `<div class="card">${profileCard(p)}</div>`;
      }catch(err){ addErr(err); box.innerHTML = `<div class="muted">불러오기 실패</div>`; }
      finally{ setLoading(e.currentTarget, false); }
    });

    $("#form-compare").addEventListener("submit", async (e)=>{
      e.preventDefault();
      const box = $("#compare-out");
      box.innerHTML = "";
      const region = $("#region2").value.trim();
      const a = $("#nameA").value.trim();
      const b = $("#nameB").value.trim();
      if (!a || !b) return;
      setLoading(e.currentTarget, true);
      try{
        let A,B;
        try{
          [A,B] = await Promise.all([fetchProfile(region,a), fetchProfile(region,b)]);
        }catch(err){
          if (DEMO){ A = demoProfile(a); B = demoProfile(b); }
          else throw err;
        }
        box.innerHTML = compareView(A,B);
      }catch(err){ addErr(err); box.innerHTML = `<div class="muted">불러오기 실패</div>`; }
      finally{ setLoading(e.currentTarget, false); }
    });

    // ====== 접근성: 엔터 제출 기본 적용 완료 ======
  </script>
</body>
</html>
