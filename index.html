<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Thunder • 전적검색·비교·랭킹</title>
<meta name="color-scheme" content="light dark">
<style>
:root{--bg:#0b0b0c;--fg:#e7e7ea;--muted:#9aa0a6;--card:#151518;--acc:#6ea8fe;--ok:#2ecc71;--bad:#ff6b6b;--warn:#f0ad4e;--line:#242428}
@media (prefers-color-scheme: light){:root{--bg:#f8f9fb;--fg:#0b0b0c;--muted:#60646c;--card:#ffffff;--line:#e7e9ef}}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR}
a{color:var(--acc);text-decoration:none}.wrap{max-width:1140px;margin:0 auto;padding:18px}
header{display:flex;align-items:center;gap:10px;margin-bottom:10px}.logo{font-weight:700}
.nav{display:flex;gap:6px;flex-wrap:wrap}.tab{padding:6px 10px;border:1px solid var(--line);border-radius:999px;cursor:pointer}
.tab[aria-selected="true"]{background:var(--acc);color:#0b0b0c;border-color:transparent}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}.grid{display:grid;gap:10px}
.g2{grid-template-columns:1fr 1fr}.g3{grid-template-columns:repeat(3,1fr)}
@media (max-width:860px){.g2,.g3{grid-template-columns:1fr}}
input,select,button{height:40px;border-radius:10px;border:1px solid var(--line);background:transparent;color:var(--fg);padding:0 12px}
button{background:var(--acc);color:#0b0b0c;border:none;font-weight:600;cursor:pointer}button[disabled]{opacity:.5;cursor:not-allowed}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.muted{color:var(--muted)}.hr{height:1px;background:var(--line);margin:10px 0}
.bar{height:10px;background:var(--line);border-radius:999px;overflow:hidden}.bar>i{display:block;height:100%;background:var(--ok)}
.kpi{display:flex;gap:8px;align-items:baseline}.kpi .v{font:600 18px/1 system-ui}.pill{padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
.table{width:100%;border-collapse:collapse}.table th,.table td{padding:8px;border-bottom:1px solid var(--line);text-align:left}
.loading{opacity:.6;pointer-events:none}.err{position:fixed;right:12px;bottom:12px;background:#1a1a1f;border:1px solid var(--line);color:#fff;padding:8px 10px;border-radius:12px;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 12h5l3-9 3 18 3-9h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
    <div class="logo">Thunder</div>
    <nav class="nav" id="nav"></nav>
  </header>

  <section id="view"></section>
</div>
<div id="err" class="err" hidden>0 error</div>

<script type="module">
const API_BASE = "https://YOUR-WORKER-NAME.workers.dev"; // 교체
const $ = (s,el=document)=>el.querySelector(s);
const out = $("#view"); const nav = $("#nav"); const outErr=$("#err"); let errN=0;
const addErr = (e)=>{errN++; outErr.textContent = errN+" error"; outErr.hidden=false; console.error(e);};
const routes = ["검색","비교","랭킹","라이브","로테이션","챔피언"];
const state = { region:"kr", queue:"RANKED_SOLO_5x5" };
routes.forEach((r,i)=>{ const b=document.createElement("button"); b.className="tab"; b.textContent=r; b.onclick=()=>go(i); nav.appendChild(b); });
function selTab(i){ [...nav.children].forEach((c,idx)=>c.setAttribute("aria-selected", idx===i?"true":"false")); }

function go(i){ selTab(i); if(i===0) viewSearch(); if(i===1) viewCompare(); if(i===2) viewLadder(); if(i===3) viewLive(); if(i===4) viewRotations(); if(i===5) viewChampions(); }
const json = async(u)=>{ const r=await fetch(u,{headers:{"Accept":"application/json"}}); if(!r.ok) throw new Error("HTTP "+r.status+" "+u); return r.json(); };
const aggKDA = (last10)=>{ const s=last10.reduce((a,m)=>{a.k+=m.k;a.d+=m.d;a.a+=m.a;a.w+=m.win?1:0;return a},{k:0,d:0,a:0,w:0}); const kda=s.d?(s.k+s.a)/s.d:(s.k+s.a); return {games:last10.length,wins:s.w,winrate:Math.round((s.w/last10.length)*100),k:s.k,d:s.d,a:s.a,kda:Number(kda.toFixed(2))}; };
const fmt = n=>Number(n).toLocaleString();

function profileCard(p){
  const k = aggKDA(p.last10||[]);
  return `<div class="grid g2" style="align-items:center">
    <div class="row" style="gap:12px">
      <div style="width:54px;height:54px;border-radius:14px;background:#222;display:grid;place-items:center;font-weight:700">${p.iconId||""}</div>
      <div><div style="font-weight:700">${p.name}</div><div class="muted">LV ${fmt(p.level||0)}</div></div>
    </div>
    <div class="row" style="justify-content:flex-end;gap:16px">
      <div class="kpi"><div class="v">${k.winrate}%</div><div class="muted">승률(10)</div></div>
      <div class="kpi"><div class="v">${k.kda}</div><div class="muted">KDA</div></div>
      <div class="kpi"><div class="v">${k.k}/${k.d}/${k.a}</div><div class="muted">합산</div></div>
    </div>
    <div class="hr"></div>
    <div class="row"><span class="pill">${p.rank?`${p.rank.tier} ${p.rank.division} • ${p.rank.lp}LP`:"Unranked"}</span><span class="pill">${state.region.toUpperCase()}</span></div>
  </div>`;
}

function viewSearch(){
  out.innerHTML = `<div class="card">
    <h3 style="margin:0 0 8px">전적 검색</h3>
    <form id="f" class="grid" style="grid-template-columns:110px 1fr 110px;gap:8px">
      ${regionSel("reg")}
      <input id="name" placeholder="Riot ID 예: Faker#KR1" autocomplete="off"/>
      <button type="submit">검색</button>
    </form>
    <div id="box" style="margin-top:10px"></div>
  </div>`;
  $("#reg").value = state.region;
  $("#f").addEventListener("submit", async (e)=>{
    e.preventDefault();
    state.region = $("#reg").value;
    const name = $("#name").value.trim();
    if(!name) return;
    const u = new URL(API_BASE+"/v1/profile"); u.searchParams.set("region", state.region); u.searchParams.set("name", name); u.searchParams.set("count","10");
    try{ const p = await json(u.toString()); $("#box").innerHTML = profileCard(p); }catch(err){ addErr(err); $("#box").innerHTML = `<div class="muted">불러오기 실패</div>`; }
  });
}

function viewCompare(){
  out.innerHTML = `<div class="card">
    <h3 style="margin:0 0 8px">비교하기</h3>
    <form id="f" class="grid" style="grid-template-columns:110px 1fr 1fr 110px;gap:8px">
      ${regionSel("reg2")}
      <input id="a" placeholder="A: Riot ID" autocomplete="off"/>
      <input id="b" placeholder="B: Riot ID" autocomplete="off"/>
      <button type="submit">비교</button>
    </form>
    <div id="box" style="margin-top:10px"></div>
  </div>`;
  $("#reg2").value = state.region;
  $("#f").addEventListener("submit", async (e)=>{
    e.preventDefault(); state.region=$("#reg2").value;
    const A=$("#a").value.trim(), B=$("#b").value.trim(); if(!A||!B) return;
    const q = (name)=>{ const u=new URL(API_BASE+"/v1/profile"); u.searchParams.set("region",state.region); u.searchParams.set("name",name); u.searchParams.set("count","10"); return json(u.toString()); };
    try{
      const [a,b]=await Promise.all([q(A),q(B)]);
      const ka=aggKDA(a.last10), kb=aggKDA(b.last10);
      const diff=(x,y)=>((x-y)>0?"+":"")+String((x-y).toFixed? (x-y).toFixed(2):(x-y));
      $("#box").innerHTML = `
        <div class="grid g2"><div class="card">${profileCard(a)}</div><div class="card">${profileCard(b)}</div></div>
        <div class="card" style="margin-top:10px">
          <h4 style="margin:0 0 6px">핵심 지표</h4>
          <table class="table">
            <tr><th>지표</th><th>A</th><th>B</th><th>Δ</th></tr>
            <tr><td>승률(10)</td><td>${ka.winrate}%</td><td>${kb.winrate}%</td><td>${diff(ka.winrate,kb.winrate)}%</td></tr>
            <tr><td>KDA</td><td>${ka.kda}</td><td>${kb.kda}</td><td>${diff(ka.kda,kb.kda)}</td></tr>
            <tr><td>합산 K/D/A</td><td>${ka.k}/${ka.d}/${ka.a}</td><td>${kb.k}/${kb.d}/${kb.a}</td><td>${diff(ka.k+ka.a,kb.k+kb.a)}</td></tr>
          </table>
        </div>`;
    }catch(err){ addErr(err); $("#box").innerHTML = `<div class="muted">불러오기 실패</div>`; }
  });
}

function viewLadder(){
  out.innerHTML = `<div class="card">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0">랭킹</h3>
      <div class="row">
        ${regionSel("reg3")}
        <select id="tier"><option value="all">All</option><option value="challenger">Challenger</option><option value="grandmaster">Grandmaster</option><option value="master">Master</option></select>
        <button id="reload">불러오기</button>
      </div>
    </div>
    <div id="box" style="margin-top:10px"></div>
  </div>`;
  $("#reg3").value = state.region;
  $("#reload").onclick = load;
  $("#tier").value = "all";
  load();
  async function load(){
    state.region=$("#reg3").value;
    const tier=$("#tier").value;
    const u=new URL(API_BASE+"/v1/ladder"); u.searchParams.set("region",state.region); u.searchParams.set("queue",state.queue); u.searchParams.set("tier",tier);
    try{
      const d=await json(u.toString());
      const rows = d.entries.map((e,i)=>`<tr><td>${i+1}</td><td>${esc(e.summonerName)}</td><td>${e.tier}</td><td>${fmt(e.leaguePoints)}</td><td>${e.wins}/${e.losses}</td></tr>`).join("");
      $("#box").innerHTML = `<table class="table"><thead><tr><th>#</th><th>소환사</th><th>티어</th><th>LP</th><th>전적</th></tr></thead><tbody>${rows}</tbody></table>`;
    }catch(err){ addErr(err); $("#box").innerHTML = `<div class="muted">불러오기 실패</div>`; }
  }
}

function viewLive(){
  out.innerHTML = `<div class="card">
    <h3 style="margin:0 0 8px">라이브 관전</h3>
    <form id="f" class="grid" style="grid-template-columns:110px 1fr 110px;gap:8px">
      ${regionSel("reg4")}
      <input id="name" placeholder="Riot ID" autocomplete="off"/>
      <button type="submit">조회</button>
    </form>
    <div id="box" style="margin-top:10px"></div>
  </div>`;
  $("#reg4").value = state.region;
  $("#f").addEventListener("submit", async (e)=>{
    e.preventDefault(); state.region=$("#reg4").value;
    const name=$("#name").value.trim(); if(!name) return;
    const u=new URL(API_BASE+"/v1/live"); u.searchParams.set("region",state.region); u.searchParams.set("name",name);
    try{
      const d=await json(u.toString());
      if(!d.inGame){ $("#box").innerHTML = `<div class="muted">게임 중 아님</div>`; return; }
      $("#box").innerHTML = `<pre style="white-space:pre-wrap">${esc(JSON.stringify(d.game, null, 2))}</pre>`;
    }catch(err){ addErr(err); $("#box").innerHTML = `<div class="muted">불러오기 실패</div>`; }
  });
}

function viewRotations(){
  out.innerHTML = `<div class="card">
    <div class="row" style="justify-content:space-between"><h3 style="margin:0">챔피언 로테이션</h3>${regionSel("reg5")}</div>
    <div id="box" style="margin-top:10px"></div>
  </div>`;
  $("#reg5").value = state.region;
  load();
  $("#reg5").onchange = load;
  async function load(){
    state.region=$("#reg5").value;
    const u=new URL(API_BASE+"/v1/rotations"); u.searchParams.set("region",state.region);
    try{
      const d=await json(u.toString());
      const ver = await json(API_BASE+"/v1/ddragon/version");
      const dj = await json(API_BASE+`/v1/ddragon/champions?ver=${ver.version}`);
      const map = Object.values(dj.data).reduce((a,c)=>{a[c.key]=c.name;return a;}, {});
      const names = d.freeChampionIds.map(id=>map[id]||id).sort();
      $("#box").innerHTML = `<div class="row">${names.map(n=>`<span class="pill">${esc(n)}</span>`).join("")}</div>`;
    }catch(err){ addErr(err); $("#box").innerHTML = `<div class="muted">불러오기 실패</div>`; }
  }
}

function viewChampions(){
  out.innerHTML = `<div class="card">
    <div class="row" style="justify-content:space-between"><h3 style="margin:0">챔피언 목록</h3></div>
    <div id="box" style="margin-top:10px"></div>
  </div>`;
  (async()=>{
    try{
      const ver = await json(API_BASE+"/v1/ddragon/version");
      const dj = await json(API_BASE+`/v1/ddragon/champions?ver=${ver.version}`);
      const cards = Object.values(dj.data).sort((a,b)=>a.name.localeCompare(b.name,"ko")).map(c=>`<div class="pill">${esc(c.name)}</div>`).join("");
      $("#box").innerHTML = `<div class="row">${cards}</div>`;
    }catch(err){ addErr(err); $("#box").innerHTML = `<div class="muted">불러오기 실패</div>`; }
  })();
}

function regionSel(id){
  return `<select id="${id}">
    <option value="kr">KR</option><option value="na1">NA</option><option value="euw1">EUW</option><option value="eun1">EUNE</option><option value="jp1">JP</option>
  </select>`;
}
const esc = (s)=>String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m]));
go(0); // 기본: 검색
</script>
</body>
</html>
